<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>First Responder Wellness Grant Finder Tool</title>
  <style>
    :root { --maxw: 1100px; }
    body { font: 16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin: 2rem; color:#111; display:flex; justify-content:center; }
    main { width:100%; max-width: var(--maxw); }
    h1 { margin: 0 0 .25rem; }
    p.sub { margin:.25rem 0 1rem; color:#555; }
    .card { border:1px solid #eee; border-radius:12px; padding:1rem; background:#fafafa; }
    .row { margin: .8rem 0; padding: 1rem; border: 1px solid #eee; border-radius: 10px; background: #fff; }
    .meta { font-size: .9em; color: #555; margin-top: .25rem; }
    .tags { font-size: .85em; color:#444; margin-top: .25rem; display:flex; flex-wrap:wrap; gap:.35rem; }
    .tag, .chip { background:#eef; padding:.2rem .5rem; border-radius:.6rem; display:inline-flex; align-items:center; gap:.35rem; }
    .chip button { border:none; background:transparent; cursor:pointer; font-weight:700; }
    .bar { margin: .75rem 0 1rem; min-height: 1.2em; color:#333; }
    button { padding: .6rem .95rem; border-radius: 10px; border:1px solid #ccc; background:#fff; cursor:pointer; font-weight:600; }
    button:hover { background:#f3f3f3; }
    ul { margin:.25rem 0 .5rem 1.1rem; }
    a { color:#0645ad; text-decoration:none; }
    a:hover { text-decoration:underline; }
    .muted { color:#666; font-size:.9em; }
    input[type="text"] { padding:.5rem .7rem; border-radius:8px; border:1px solid #ccc; }
    select, .pill { padding:.45rem .6rem; border-radius:8px; border:1px solid #ccc; background:#fff; }
    .grid { display:grid; gap:.75rem; grid-template-columns: repeat(12, 1fr); }
    .col-12 { grid-column: span 12; }
    .col-6  { grid-column: span 6; }
    .controls { margin-top:1rem; }
    .empty { color:#666; font-style: italic; margin-top:.5rem; }
    .inline { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    .pill { display:inline-flex; gap:.4rem; align-items:center; }
    .section-title { margin:.75rem 0 .35rem; font-weight:700; }
    .counts { font-size:.9em; color:#444; }
    .source-chip { background:#f0f7ff; }
  </style>
</head>
<body>
<main>
  <!-- Header / Name -->
  <h1>First Responder Wellness Grant Finder Tool</h1>
  <p class="sub">Find grants supporting wellness programs, psych evaluations, critical incident stress debriefing, and fitness for duty.</p>

  <!-- Sources + Update button -->
  <section class="card">
    <h2 style="margin-top:0">Sources used</h2>
    <ul>
      <li>
        <strong>Grants.gov Search (official API)</strong> —
        <a href="https://www.grants.gov/search-grants" target="_blank" rel="noopener noreferrer">search page</a>
      </li>
      <li>
        <strong>State of Ohio Funding Opportunities</strong> —
        <a href="https://grants.ohio.gov/funding-opportunities" target="_blank" rel="noopener noreferrer">landing page</a>
      </li>
    </ul>

    <button id="loadBtn" type="button">Update / Load Grants</button>
    <div class="bar" id="stats" aria-live="polite"></div>
    <div class="counts" id="sourceCounts"></div>
    <div class="muted">The button reads <code>data/grants.json</code> (built by GitHub Actions). Choose sources & filters below.</div>
  </section>

  <!-- Source selector -->
  <section class="controls card">
    <div class="section-title">Sources to include</div>
    <div class="inline">
      <label class="pill"><input type="checkbox" name="src" value="grants.gov" checked> <span class="chip source-chip">grants.gov</span></label>
      <label class="pill"><input type="checkbox" name="src" value="ohio-grants" checked> <span class="chip source-chip">ohio-grants</span></label>
    </div>

    <div class="section-title">Search keywords (editable)</div>
    <div id="kwChips" class="inline" aria-live="polite"></div>
    <div class="inline" style="margin-top:.5rem;">
      <input id="kwInput" type="text" placeholder="Add keyword (e.g., 'first responder')" />
      <button id="kwAddBtn" type="button">Add keyword</button>
      <button id="kwClearBtn" type="button">Clear all</button>
    </div>
    <div class="muted" style="margin-top:.25rem">These keywords filter the loaded results on this page. To change the scraper defaults, edit the Python files in <code>scrapers/</code>.</div>

    <!-- Site-specific filters -->
    <div class="grid" style="margin-top:1rem">
      <!-- Grants.gov filters -->
      <div class="col-6">
        <div class="section-title">Grants.gov filters</div>
        <label><strong>Agency</strong></label><br/>
        <select id="ggAgency" multiple size="6" style="width:100%;"></select>
        <div style="height:.5rem"></div>
        <label><strong>Grant type (Funding Instrument)</strong></label><br/>
        <select id="ggType" multiple size="6" style="width:100%;"></select>
        <div style="height:.5rem"></div>
        <div class="inline">
          <span><strong>Status:</strong></span>
          <label class="pill"><input type="checkbox" name="ggstatus" value="posted"> posted</label>
          <label class="pill"><input type="checkbox" name="ggstatus" value="forecasted"> forecasted</label>
          <label class="pill"><input type="checkbox" name="ggstatus" value="closed"> closed</label>
          <label class="pill"><input type="checkbox" name="ggstatus" value="archived"> archived</label>
        </div>
      </div>

      <!-- Ohio filters -->
      <div class="col-6">
        <div class="section-title">Ohio (grants.ohio.gov) filters</div>
        <label><strong>Ohio Agency</strong></label><br/>
        <select id="ohAgency" multiple size="6" style="width:100%;"></select>
        <div style="height:.5rem"></div>
        <label><strong>Ohio Categories</strong></label><br/>
        <select id="ohCats" multiple size="6" style="width:100%;"></select>
      </div>
    </div>
  </section>

  <!-- Results -->
  <section style="margin-top:1.25rem">
    <div id="list"></div>
  </section>
</main>

<script>
const state = {
  items: [],
  metaTime: "",
  defaultKeywords: [],
  userKeywords: [],
  sourceCounts: {},
  selectedSources: new Set(["grants.gov","ohio-grants"]),

  // facets
  gg: { agencies: [], types: [], statuses: [] },
  oh: { agencies: [], categories: [] },
  sel: { ggAgencies:new Set(), ggTypes:new Set(), ggStatuses:new Set(),
         ohAgencies:new Set(), ohCats:new Set() },
};

function sanitize(t){ return (t||"").replace(/</g,"&lt;"); }
function uniqueSorted(a){ return [...new Set(a.filter(Boolean))].sort((x,y)=>x.localeCompare(y)); }

function buildFacets(items){
  const ggA=[], ggT=[], ggS=[], ohA=[], ohC=[];
  for(const it of items){
    if(it.source==="grants.gov"){
      if (it.agency_name) ggA.push(it.agency_name);
      if (Array.isArray(it.funding_instruments)) ggT.push(...it.funding_instruments);
      if (it.opp_status) ggS.push((it.opp_status||"").toLowerCase());
    } else if (it.source==="ohio-grants"){
      if (it.agency_name) ohA.push(it.agency_name);
      if (Array.isArray(it.ohio_categories)) ohC.push(...it.ohio_categories);
    }
  }
  state.gg.agencies = uniqueSorted(ggA);
  state.gg.types    = uniqueSorted(ggT);
  state.gg.statuses = uniqueSorted(ggS);
  state.oh.agencies = uniqueSorted(ohA);
  state.oh.categories = uniqueSorted(ohC);

  // hydrate controls
  const ggAgency = document.getElementById("ggAgency");
  ggAgency.innerHTML = state.gg.agencies.map(a=>`<option value="${sanitize(a)}">${sanitize(a)}</option>`).join("");
  ggAgency.addEventListener("change", ()=>{
    state.sel.ggAgencies = new Set([...ggAgency.selectedOptions].map(o=>o.value));
    render();
  });

  const ggType = document.getElementById("ggType");
  ggType.innerHTML = state.gg.types.map(t=>`<option value="${sanitize(t)}">${sanitize(t)}</option>`).join("");
  ggType.addEventListener("change", ()=>{
    state.sel.ggTypes = new Set([...ggType.selectedOptions].map(o=>o.value));
    render();
  });

  document.querySelectorAll("input[name='ggstatus']").forEach(cb=>{
    cb.addEventListener("change", ()=>{
      const s=new Set();
      document.querySelectorAll("input[name='ggstatus']:checked").forEach(x=>s.add(x.value));
      state.sel.ggStatuses = s; render();
    });
  });

  const ohAgency = document.getElementById("ohAgency");
  ohAgency.innerHTML = state.oh.agencies.map(a=>`<option value="${sanitize(a)}">${sanitize(a)}</option>`).join("");
  ohAgency.addEventListener("change", ()=>{
    state.sel.ohAgencies = new Set([...ohAgency.selectedOptions].map(o=>o.value));
    render();
  });

  const ohCats = document.getElementById("ohCats");
  ohCats.innerHTML = state.oh.categories.map(c=>`<option value="${sanitize(c)}">${sanitize(c)}</option>`).join("");
  ohCats.addEventListener("change", ()=>{
    state.sel.ohCats = new Set([...ohCats.selectedOptions].map(o=>o.value));
    render();
  });

  // source checkboxes
  document.querySelectorAll("input[name='src']").forEach(cb=>{
    cb.checked = state.selectedSources.has(cb.value);
    cb.addEventListener("change", ()=>{
      if(cb.checked) state.selectedSources.add(cb.value);
      else state.selectedSources.delete(cb.value);
      render();
    });
  });
}

function renderKeywordChips(){
  const wrap = document.getElementById("kwChips");
  if(!state.userKeywords.length){
    wrap.innerHTML = `<span class="muted">No keywords set. (Showing all loaded results)</span>`;
    return;
  }
  wrap.innerHTML = state.userKeywords.map((kw,i)=>`
    <span class="chip">${sanitize(kw)} <button data-idx="${i}" title="Remove ${sanitize(kw)}">×</button></span>
  `).join("");
  wrap.querySelectorAll("button[data-idx]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const idx=Number(btn.getAttribute("data-idx"));
      state.userKeywords.splice(idx,1);
      renderKeywordChips(); render();
    });
  });
}

function appliesSource(it){
  return state.selectedSources.has(it.source);
}

function appliesSiteFilters(it){
  if(it.source==="grants.gov"){
    if (state.sel.ggAgencies.size && !state.sel.ggAgencies.has(it.agency_name)) return false;
    if (state.sel.ggTypes.size) {
      const ok = (it.funding_instruments||[]).some(t=>state.sel.ggTypes.has(t));
      if(!ok) return false;
    }
    if (state.sel.ggStatuses.size) {
      const st=(it.opp_status||"").toLowerCase();
      if(!state.sel.ggStatuses.has(st)) return false;
    }
  }
  if(it.source==="ohio-grants"){
    if (state.sel.ohAgencies.size && !state.sel.ohAgencies.has(it.agency_name)) return false;
    if (state.sel.ohCats.size) {
      const ok = (it.ohio_categories||[]).some(c=>state.sel.ohCats.has(c));
      if(!ok) return false;
    }
  }
  return true;
}

function render(){
  const listEl = document.getElementById("list");
  const statsEl = document.getElementById("stats");
  const scEl = document.getElementById("sourceCounts");

  const kw = state.userKeywords.map(s=>s.toLowerCase());
  const shown = state.items.filter(it=>{
    if(!appliesSource(it)) return false;

    // Keyword filter (ANY)
    if(kw.length){
      const blob = [it.title, it.description, it.agency_name, (it.tags||[]).join(" "), (it.funding_instruments||[]).join(" "), (it.ohio_categories||[]).join(" ")].join(" ").toLowerCase();
      if(!kw.some(k=>blob.includes(k))) return false;
    }

    // Site-specific filters
    if(!appliesSiteFilters(it)) return false;

    return true;
  });

  statsEl.textContent = `${shown.length} result${shown.length===1?"":"s"} — updated ${state.metaTime || "pending first scrape"}`;
  scEl.textContent = Object.keys(state.sourceCounts||{}).length
    ? "By source: " + Object.entries(state.sourceCounts).map(([k,v])=>`${k}=${v}`).join(" · ")
    : "";

  if(!shown.length){ listEl.innerHTML = `<div class="empty">No results match your filters.</div>`; return; }

  listEl.innerHTML = shown.map(it=>`
    <div class="row">
      <div><a href="${it.url}" target="_blank" rel="noopener noreferrer"><strong>${sanitize(it.title)}</strong></a></div>
      <div class="meta">
        ${sanitize(it.source)}${it.agency_name ? " • " + sanitize(it.agency_name) : ""}
        ${it.opp_status ? " • " + sanitize(it.opp_status) : ""}
        ${it.posted_date ? " • posted " + it.posted_date : ""}
        ${it.deadline_date ? " • due " + it.deadline_date : ""}
        ${it.opportunity_number ? " • " + sanitize(it.opportunity_number) : ""}
      </div>
      <div>${sanitize(it.description || "")}</div>
      <div class="tags">
        ${(it.funding_instruments||[]).map(t=>`<span class="tag">${sanitize(t)}</span>`).join("")}
        ${(it.funding_categories||[]).map(t=>`<span class="tag">${sanitize(t)}</span>`).join("")}
        ${(it.eligibilities||[]).map(t=>`<span class="tag">${sanitize(t)}</span>`).join("")}
        ${(it.ohio_categories||[]).map(t=>`<span class="tag">${sanitize(t)}</span>`).join("")}
        ${(it.alns||[]).map(t=>`<span class="tag">ALN ${sanitize(t)}</span>`).join("")}
      </div>
    </div>
  `).join("");
}

async function loadGrants(){
  const statsEl=document.getElementById("stats");
  const btn=document.getElementById("loadBtn");
  try{
    btn.disabled=true; btn.textContent="Loading…";
    statsEl.textContent="Fetching latest data…";

    const res = await fetch("./data/grants.json?ts="+Date.now(), {cache:"no-store"});
    if(!res.ok) throw new Error("HTTP "+res.status);
    const data = await res.json();

    state.items = Array.isArray(data.items)? data.items: [];
    state.metaTime = data.generated_at || "";
    state.sourceCounts = data.source_counts || {};

    // Defaults from meta.keywords
    const metaKW = (data.meta && data.meta.keywords) || {};
    const keysets = Object.values(metaKW).flat();
    state.defaultKeywords = [...new Set(keysets)];
    state.userKeywords = [...state.defaultKeywords];

    buildFacets(state.items);
    renderKeywordChips();
    render();
  }catch(e){
    statsEl.textContent = "Could not load data/grants.json yet.";
  }finally{
    btn.disabled=false; btn.textContent="Update / Load Grants";
  }
}

// Keyword controls
document.getElementById("kwAddBtn").addEventListener("click", ()=>{
  const inp=document.getElementById("kwInput");
  const v=(inp.value||"").trim();
  if(!v) return;
  if(!state.userKeywords.includes(v)) state.userKeywords.push(v);
  inp.value=""; renderKeywordChips(); render();
});
document.getElementById("kwClearBtn").addEventListener("click", ()=>{
  state.userKeywords=[]; renderKeywordChips(); render();
});

document.getElementById("loadBtn").addEventListener("click", loadGrants);
</script>
</body>
</html>
